{% extends "base.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item active">สินค้า</li>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="page-title">จัดการสินค้า</h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
            <i class="bi bi-plus-circle me-1"></i> เพิ่มสินค้า
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="row g-2 align-items-center">
            <div class="col-md-3">
                <select class="form-select form-select-sm" id="typeFilter">
                    <option value="">ทุกประเภท</option>
                    <option value="NORMAL">NORMAL - สินค้าทั่วไป</option>
                    <option value="SET">SET - ชุดสินค้า</option>
                    <option value="GIFT">GIFT - ของแถม</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="ค้นหา SKU หรือชื่อ...">
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-sm w-100" onclick="loadProducts()">
                    <i class="bi bi-filter me-1"></i> กรอง
                </button>
            </div>
            <div class="col-md-3 text-end">
                <a href="/stock" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-stack me-1"></i> บริหารสต๊อก
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px;">รูป</th>
                        <th>SKU</th>
                        <th>ชื่อสินค้า</th>
                        <th>ประเภท</th>
                        <th class="text-end">ต้นทุน</th>
                        <th class="text-end">ราคาขาย</th>
                        <th>สถานะ</th>
                        <th style="width: 100px;"></th>
                    </tr>
                </thead>
                <tbody id="productsTable">
                    <tr>
                        <td colspan="8" class="text-center text-muted py-5">
                            <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                            กำลังโหลด...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="card-footer">
        <div class="text-muted small" id="paginationInfo">แสดง 0 รายการ</div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">เพิ่มสินค้าใหม่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <div class="modal-body">
                    <input type="hidden" name="id" id="productId">
                    <div class="mb-3">
                        <label class="form-label">SKU <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="sku" id="productSku" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ชื่อสินค้า <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ประเภท</label>
                        <select class="form-select" name="product_type" id="productType">
                            <option value="NORMAL">NORMAL - สินค้าทั่วไป</option>
                            <option value="SET">SET - ชุดสินค้า</option>
                            <option value="GIFT">GIFT - ของแถม</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ต้นทุน</label>
                            <input type="number" class="form-control" name="standard_cost" id="productCost" step="0.01" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ราคาขาย</label>
                            <input type="number" class="form-control" name="standard_price" id="productPrice" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL รูปภาพ</label>
                        <input type="url" class="form-control" name="image_url" id="productImage">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i> บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let productModalInstance;
    
    document.addEventListener('DOMContentLoaded', () => {
        productModalInstance = new bootstrap.Modal(document.getElementById('productModal'));
        loadProducts();
        
        document.getElementById('productModal').addEventListener('hidden.bs.modal', resetForm);
    });
    
    async function loadProducts() {
        const search = document.getElementById('searchInput').value;
        const type = document.getElementById('typeFilter').value;
        const params = new URLSearchParams({ search, product_type: type });
        
        try {
            const res = await fetch(`/api/products?${params}`);
            if (res.ok) {
                const data = await res.json();
                renderProducts(data.products);
                document.getElementById('paginationInfo').textContent = `แสดง ${data.products.length} จาก ${data.total} รายการ`;
            }
        } catch (e) {
            console.error('Failed to load products:', e);
        }
    }
    
    function renderProducts(products) {
        const tbody = document.getElementById('productsTable');
        
        if (!products || products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-5">
                        <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                        ไม่พบสินค้า
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = products.map(p => `
            <tr>
                <td>
                    <img src="${p.image_url || '/static/img/no-image.png'}" class="product-thumb" alt="">
                </td>
                <td class="text-mono">${p.sku}</td>
                <td>${p.name}</td>
                <td><span class="badge bg-secondary">${p.product_type}</span></td>
                <td class="text-end text-mono">฿${parseFloat(p.standard_cost || 0).toFixed(2)}</td>
                <td class="text-end text-mono">฿${parseFloat(p.standard_price || 0).toFixed(2)}</td>
                <td>
                    ${p.is_active 
                        ? '<span class="badge bg-success">ใช้งาน</span>' 
                        : '<span class="badge bg-secondary">ปิดใช้งาน</span>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editProduct(${JSON.stringify(p)})'>
                        <i class="bi bi-pencil"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function editProduct(product) {
        document.getElementById('modalTitle').textContent = 'แก้ไขสินค้า';
        document.getElementById('productId').value = product.id;
        document.getElementById('productSku').value = product.sku;
        document.getElementById('productName').value = product.name;
        document.getElementById('productType').value = product.product_type;
        document.getElementById('productCost').value = product.standard_cost;
        document.getElementById('productPrice').value = product.standard_price;
        document.getElementById('productImage').value = product.image_url || '';
        
        productModalInstance.show();
    }
    
    function resetForm() {
        document.getElementById('modalTitle').textContent = 'เพิ่มสินค้าใหม่';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
    }
    
    async function saveProduct(e) {
        e.preventDefault();
        
        const form = document.getElementById('productForm');
        const formData = new FormData(form);
        const id = formData.get('id');
        
        const productData = {
            sku: formData.get('sku'),
            name: formData.get('name'),
            product_type: formData.get('product_type'),
            standard_cost: parseFloat(formData.get('standard_cost')) || 0,
            standard_price: parseFloat(formData.get('standard_price')) || 0,
            image_url: formData.get('image_url') || null
        };
        
        try {
            let res;
            if (id) {
                res = await fetch(`/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            } else {
                res = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            }
            
            if (res.ok) {
                productModalInstance.hide();
                loadProducts();
            } else {
                const error = await res.json();
                alert(error.detail || 'เกิดข้อผิดพลาด');
            }
        } catch (e) {
            console.error('Failed to save product:', e);
            alert('เกิดข้อผิดพลาดในการบันทึก');
        }
    }
    
    // Search on enter
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadProducts();
    });
</script>
{% endblock %}
