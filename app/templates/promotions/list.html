{% extends "base.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item active">โปรโมชั่น</li>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="page-title">จัดการโปรโมชั่น</h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#promoModal">
            <i class="bi bi-plus-circle me-1"></i> สร้างโปรโมชั่น
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ชื่อโปรโมชั่น</th>
                        <th>เงื่อนไข</th>
                        <th>ของแถม</th>
                        <th>ช่องทาง</th>
                        <th>ระยะเวลา</th>
                        <th>สถานะ</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="promoTable">
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            กำลังโหลด...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Promo Modal -->
<div class="modal fade" id="promoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">สร้างโปรโมชั่นใหม่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="promoForm" onsubmit="savePromo(event)">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">ชื่อโปรโมชั่น <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" required placeholder="เช่น ซื้อครบ 500 แถมฟรี">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">ประเภทเงื่อนไข</label>
                            <select class="form-select" name="condition_type" onchange="updateConditionUI(this.value)">
                                <option value="MIN_ORDER_AMOUNT">ยอดขั้นต่ำ</option>
                                <option value="MIN_QTY">จำนวนสินค้าขั้นต่ำ</option>
                                <option value="SKU_CONTAINS">มี SKU ที่กำหนด</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6" id="conditionValueContainer">
                            <label class="form-label">ยอดขั้นต่ำ (฿)</label>
                            <input type="number" class="form-control" name="condition_value" value="0" min="0">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">ช่องทาง</label>
                            <select class="form-select" name="channel_filter">
                                <option value="all">ทุกช่องทาง</option>
                                <option value="shopee">Shopee</option>
                                <option value="lazada">Lazada</option>
                                <option value="tiktok">TikTok</option>
                                <option value="facebook">Facebook</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">ลำดับความสำคัญ</label>
                            <input type="number" class="form-control" name="priority" value="0">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">วันเริ่มต้น</label>
                            <input type="datetime-local" class="form-control" name="start_at">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">วันสิ้นสุด</label>
                            <input type="datetime-local" class="form-control" name="end_at">
                        </div>
                        
                        <div class="col-12">
                            <hr>
                            <h6>ของแถม</h6>
                        </div>
                        
                        <div class="col-md-8">
                            <label class="form-label">สินค้าแถม</label>
                            <select class="form-select" name="free_product_id" id="freeProductSelect">
                                <option value="">เลือกสินค้า...</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">จำนวน</label>
                            <input type="number" class="form-control" name="free_quantity" value="1" min="1">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i> บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let promoModal;
    
    document.addEventListener('DOMContentLoaded', () => {
        promoModal = new bootstrap.Modal(document.getElementById('promoModal'));
        loadPromotions();
        loadProducts();
    });
    
    async function loadPromotions() {
        try {
            const res = await fetch('/api/promotions');
            if (res.ok) {
                const data = await res.json();
                renderPromotions(data);
            }
        } catch (e) {
            console.error('Failed to load promotions:', e);
        }
    }
    
    async function loadProducts() {
        try {
            const res = await fetch('/api/products?product_type=GIFT');
            if (res.ok) {
                const data = await res.json();
                const select = document.getElementById('freeProductSelect');
                select.innerHTML = '<option value="">เลือกสินค้า...</option>' + 
                    data.products.map(p => `<option value="${p.id}">${p.sku} - ${p.name}</option>`).join('');
            }
        } catch (e) {
            console.error('Failed to load products:', e);
        }
    }
    
    function renderPromotions(promos) {
        const tbody = document.getElementById('promoTable');
        
        if (!promos || promos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-5">
                        <i class="bi bi-gift fs-1 d-block mb-2"></i>
                        ยังไม่มีโปรโมชั่น
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = promos.map(p => {
            let conditionText = '';
            if (p.condition_type === 'MIN_ORDER_AMOUNT') {
                conditionText = `ยอดขั้นต่ำ ฿${p.condition_json?.min_amount || 0}`;
            } else if (p.condition_type === 'MIN_QTY') {
                conditionText = `จำนวนขั้นต่ำ ${p.condition_json?.min_qty || 0} ชิ้น`;
            } else if (p.condition_type === 'SKU_CONTAINS') {
                conditionText = `มี SKU: ${(p.condition_json?.skus || []).join(', ')}`;
            }
            
            const freeItems = (p.actions || [])
                .filter(a => a.action_type === 'ADD_FREE_ITEM')
                .map(a => `${a.free_sku || 'สินค้า'} x${a.free_quantity}`)
                .join(', ');
            
            return `
                <tr>
                    <td class="fw-semibold">${p.name}</td>
                    <td><small>${conditionText}</small></td>
                    <td><small>${freeItems || '-'}</small></td>
                    <td><span class="badge bg-secondary">${p.channel_filter || 'all'}</span></td>
                    <td>
                        <small>
                            ${p.start_at ? new Date(p.start_at).toLocaleDateString('th-TH') : '-'} 
                            ถึง 
                            ${p.end_at ? new Date(p.end_at).toLocaleDateString('th-TH') : '-'}
                        </small>
                    </td>
                    <td>
                        ${p.is_active 
                            ? '<span class="badge bg-success">ใช้งาน</span>' 
                            : '<span class="badge bg-secondary">ปิด</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-${p.is_active ? 'warning' : 'success'}" 
                                onclick="togglePromo('${p.id}')">
                            <i class="bi bi-${p.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function updateConditionUI(type) {
        const container = document.getElementById('conditionValueContainer');
        if (type === 'MIN_ORDER_AMOUNT') {
            container.innerHTML = `
                <label class="form-label">ยอดขั้นต่ำ (฿)</label>
                <input type="number" class="form-control" name="condition_value" value="0" min="0">
            `;
        } else if (type === 'MIN_QTY') {
            container.innerHTML = `
                <label class="form-label">จำนวนชิ้นขั้นต่ำ</label>
                <input type="number" class="form-control" name="condition_value" value="1" min="1">
            `;
        } else {
            container.innerHTML = `
                <label class="form-label">SKU (คั่นด้วยจุลภาค)</label>
                <input type="text" class="form-control" name="condition_value" placeholder="SKU1, SKU2">
            `;
        }
    }
    
    async function savePromo(e) {
        e.preventDefault();
        
        const form = document.getElementById('promoForm');
        const formData = new FormData(form);
        
        const conditionType = formData.get('condition_type');
        let conditionJson = {};
        const conditionValue = formData.get('condition_value');
        
        if (conditionType === 'MIN_ORDER_AMOUNT') {
            conditionJson = { min_amount: parseFloat(conditionValue) || 0 };
        } else if (conditionType === 'MIN_QTY') {
            conditionJson = { min_qty: parseInt(conditionValue) || 1 };
        } else if (conditionType === 'SKU_CONTAINS') {
            conditionJson = { skus: conditionValue.split(',').map(s => s.trim()).filter(Boolean) };
        }
        
        const data = {
            name: formData.get('name'),
            condition_type: conditionType,
            condition_json: conditionJson,
            channel_filter: formData.get('channel_filter'),
            priority: parseInt(formData.get('priority')) || 0,
            start_at: formData.get('start_at') || null,
            end_at: formData.get('end_at') || null,
            actions: []
        };
        
        const freeProductId = formData.get('free_product_id');
        if (freeProductId) {
            data.actions.push({
                action_type: 'ADD_FREE_ITEM',
                free_product_id: freeProductId,
                free_quantity: parseInt(formData.get('free_quantity')) || 1
            });
        }
        
        try {
            const res = await fetch('/api/promotions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                promoModal.hide();
                form.reset();
                loadPromotions();
            } else {
                const error = await res.json();
                alert(error.detail || 'เกิดข้อผิดพลาด');
            }
        } catch (e) {
            console.error('Failed to save promo:', e);
            alert('เกิดข้อผิดพลาดในการบันทึก');
        }
    }
    
    async function togglePromo(id) {
        try {
            const res = await fetch(`/api/promotions/${id}/toggle`, { method: 'POST' });
            if (res.ok) {
                loadPromotions();
            }
        } catch (e) {
            console.error('Failed to toggle promo:', e);
        }
    }
</script>
{% endblock %}
