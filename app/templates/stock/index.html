{% extends "base.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item active">สต๊อก</li>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="page-title">บริหารสต๊อก</h1>
    <div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#adjustModal">
            <i class="bi bi-plus-circle me-1"></i> รับสินค้าเข้า
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="row g-2 align-items-center">
            <div class="col-md-3">
                <select class="form-select form-select-sm" id="warehouseFilter">
                    <option value="">ทุกคลัง</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="ค้นหา SKU หรือชื่อ...">
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-sm w-100" onclick="loadStock()">
                    <i class="bi bi-filter me-1"></i> กรอง
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Stock Summary -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-stack me-2"></i>ภาพรวมสต๊อก
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>ชื่อสินค้า</th>
                                <th>คลัง</th>
                                <th class="text-end">คงเหลือ</th>
                                <th class="text-end">จอง</th>
                                <th class="text-end">พร้อมขาย</th>
                            </tr>
                        </thead>
                        <tbody id="stockTable">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    กำลังโหลด...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Movements -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i>ประวัติล่าสุด</span>
                <select class="form-select form-select-sm" style="width: auto;" id="movementTypeFilter" onchange="loadMovements()">
                    <option value="">ทั้งหมด</option>
                    <option value="IN">รับเข้า</option>
                    <option value="OUT">จ่ายออก</option>
                    <option value="RESERVE">จอง</option>
                    <option value="ADJUST">ปรับ</option>
                </select>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="movementsList" style="max-height: 500px; overflow-y: auto;">
                    <div class="list-group-item text-center text-muted">กำลังโหลด...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Adjust Stock Modal -->
<div class="modal fade" id="adjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">รับสินค้าเข้า / ปรับสต๊อก</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="adjustForm" onsubmit="submitAdjustment(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ประเภท</label>
                        <select class="form-select" name="movement_type">
                            <option value="IN">รับเข้า (IN)</option>
                            <option value="ADJUST">ปรับสต๊อก (ADJUST)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">คลัง</label>
                        <select class="form-select" name="warehouse_id" id="adjustWarehouse" required>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">สินค้า</label>
                        <select class="form-select" name="product_id" id="adjustProduct" required>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">จำนวน</label>
                        <input type="number" class="form-control" name="quantity" required min="1" value="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">หมายเหตุ</label>
                        <input type="text" class="form-control" name="note" placeholder="เช่น รับจาก Supplier">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i> บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let adjustModal;
    
    document.addEventListener('DOMContentLoaded', () => {
        adjustModal = new bootstrap.Modal(document.getElementById('adjustModal'));
        loadWarehouses();
        loadProducts();
        loadStock();
        loadMovements();
    });
    
    async function loadWarehouses() {
        try {
            const res = await fetch('/api/warehouses');
            if (res.ok) {
                const data = await res.json();
                const options = data.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
                document.getElementById('warehouseFilter').innerHTML = '<option value="">ทุกคลัง</option>' + options;
                document.getElementById('adjustWarehouse').innerHTML = options;
            }
        } catch (e) {
            console.error('Failed to load warehouses:', e);
        }
    }
    
    async function loadProducts() {
        try {
            const res = await fetch('/api/products');
            if (res.ok) {
                const data = await res.json();
                const options = data.products.map(p => `<option value="${p.id}">${p.sku} - ${p.name}</option>`).join('');
                document.getElementById('adjustProduct').innerHTML = options;
            }
        } catch (e) {
            console.error('Failed to load products:', e);
        }
    }
    
    async function loadStock() {
        const warehouse = document.getElementById('warehouseFilter').value;
        const search = document.getElementById('searchInput').value;
        const params = new URLSearchParams({ warehouse_id: warehouse, search });
        
        try {
            const res = await fetch(`/api/stock/summary?${params}`);
            if (res.ok) {
                const data = await res.json();
                renderStock(data);
            }
        } catch (e) {
            console.error('Failed to load stock:', e);
        }
    }
    
    function renderStock(stocks) {
        const tbody = document.getElementById('stockTable');
        
        if (!stocks || stocks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-5">
                        ไม่พบข้อมูลสต๊อก
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = stocks.map(s => `
            <tr>
                <td class="text-mono">${s.sku}</td>
                <td>${s.product_name}</td>
                <td><span class="badge bg-secondary">${s.warehouse_name}</span></td>
                <td class="text-end text-mono">${s.on_hand}</td>
                <td class="text-end text-mono text-warning">${s.reserved}</td>
                <td class="text-end text-mono fw-bold ${s.available <= 0 ? 'text-danger' : 'text-success'}">${s.available}</td>
            </tr>
        `).join('');
    }
    
    async function loadMovements() {
        const type = document.getElementById('movementTypeFilter').value;
        const params = new URLSearchParams({ movement_type: type });
        
        try {
            const res = await fetch(`/api/stock/movements?${params}`);
            if (res.ok) {
                const data = await res.json();
                renderMovements(data);
            }
        } catch (e) {
            console.error('Failed to load movements:', e);
        }
    }
    
    function renderMovements(movements) {
        const list = document.getElementById('movementsList');
        
        if (!movements || movements.length === 0) {
            list.innerHTML = '<div class="list-group-item text-center text-muted">ไม่มีประวัติ</div>';
            return;
        }
        
        list.innerHTML = movements.map(m => {
            const typeClass = {
                'IN': 'success',
                'OUT': 'danger',
                'RESERVE': 'warning',
                'RELEASE': 'info',
                'ADJUST': 'secondary'
            }[m.movement_type] || 'secondary';
            
            return `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-${typeClass}">${m.movement_type}</span>
                        <small class="text-muted">${new Date(m.created_at).toLocaleString('th-TH')}</small>
                    </div>
                    <div class="mt-1">
                        <span class="text-mono">${m.sku || ''}</span>
                        <span class="float-end fw-bold ${m.quantity >= 0 ? 'text-success' : 'text-danger'}">
                            ${m.quantity >= 0 ? '+' : ''}${m.quantity}
                        </span>
                    </div>
                    ${m.note ? `<small class="text-muted">${m.note}</small>` : ''}
                </div>
            `;
        }).join('');
    }
    
    async function submitAdjustment(e) {
        e.preventDefault();
        
        const form = document.getElementById('adjustForm');
        const formData = new FormData(form);
        
        const data = {
            warehouse_id: formData.get('warehouse_id'),
            product_id: formData.get('product_id'),
            movement_type: formData.get('movement_type'),
            quantity: parseInt(formData.get('quantity')),
            reference_type: 'ADJUSTMENT',
            note: formData.get('note')
        };
        
        try {
            const res = await fetch('/api/stock/movements', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                adjustModal.hide();
                form.reset();
                loadStock();
                loadMovements();
            } else {
                const error = await res.json();
                alert(error.detail || 'เกิดข้อผิดพลาด');
            }
        } catch (e) {
            console.error('Failed to submit adjustment:', e);
            alert('เกิดข้อผิดพลาดในการบันทึก');
        }
    }
</script>
{% endblock %}
