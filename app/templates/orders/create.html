{% extends "base.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/orders" class="text-decoration-none">ออเดอร์</a></li>
<li class="breadcrumb-item active">สร้างออเดอร์</li>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">สร้างออเดอร์ใหม่</h1>
</div>

<form id="orderForm" onsubmit="submitOrder(event)">
    <div class="row g-3">
        <!-- Customer Info -->
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-person me-2"></i>ข้อมูลลูกค้า
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">ชื่อลูกค้า</label>
                            <input type="text" class="form-control" name="customer_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">เบอร์โทร</label>
                            <input type="tel" class="form-control" name="customer_phone">
                        </div>
                        <div class="col-12">
                            <label class="form-label">ที่อยู่จัดส่ง</label>
                            <textarea class="form-control" name="customer_address" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Items -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-cart me-2"></i>รายการสินค้า</span>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addItem()">
                        <i class="bi bi-plus"></i> เพิ่มรายการ
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 40%;">สินค้า</th>
                                <th style="width: 15%;">จำนวน</th>
                                <th style="width: 20%;">ราคา/หน่วย</th>
                                <th style="width: 20%;">รวม</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable">
                            <tr id="emptyRow">
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="bi bi-bag-plus fs-1 d-block mb-2"></i>
                                    คลิก "เพิ่มรายการ" เพื่อเพิ่มสินค้า
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>รายละเอียดออเดอร์
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">ช่องทาง</label>
                        <select class="form-select" name="channel_code">
                            <option value="manual">Manual / Key-in</option>
                            <option value="facebook">Facebook</option>
                            <option value="line">Line</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">วิธีชำระเงิน</label>
                        <select class="form-select" name="payment_method">
                            <option value="TRANSFER">โอนเงิน</option>
                            <option value="COD">เก็บเงินปลายทาง</option>
                            <option value="CREDIT_CARD">บัตรเครดิต</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">วิธีจัดส่ง</label>
                        <select class="form-select" name="shipping_method">
                            <option value="KERRY">Kerry Express</option>
                            <option value="FLASH">Flash Express</option>
                            <option value="THAIPOST">ไปรษณีย์ไทย</option>
                            <option value="PICKUP">รับเอง</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-calculator me-2"></i>สรุปยอด
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">ราคารวม</span>
                        <span class="text-mono" id="subtotal">฿0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 align-items-center">
                        <span class="text-muted">ค่าจัดส่ง</span>
                        <input type="number" class="form-control form-control-sm text-end text-mono" 
                               style="width: 100px;" name="shipping_fee" value="0" 
                               onchange="calculateTotal()">
                    </div>
                    <div class="d-flex justify-content-between mb-3 align-items-center">
                        <span class="text-muted">ส่วนลด</span>
                        <input type="number" class="form-control form-control-sm text-end text-mono" 
                               style="width: 100px;" name="discount_amount" value="0" 
                               onchange="calculateTotal()">
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fs-5 fw-bold">
                        <span>ยอดรวมสุทธิ</span>
                        <span class="text-primary text-mono" id="totalAmount">฿0.00</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                        <i class="bi bi-check-circle me-1"></i> สร้างออเดอร์
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Product Search Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">เลือกสินค้า</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="productSearch" placeholder="ค้นหา SKU หรือชื่อสินค้า...">
                </div>
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>รูป</th>
                                <th>SKU</th>
                                <th>ชื่อสินค้า</th>
                                <th>ราคา</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="productList">
                            <tr>
                                <td colspan="5" class="text-center text-muted">กรุณาค้นหาสินค้า</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let items = [];
    let productModal;
    
    document.addEventListener('DOMContentLoaded', () => {
        productModal = new bootstrap.Modal(document.getElementById('productModal'));
    });
    
    function addItem() {
        productModal.show();
        document.getElementById('productSearch').focus();
    }
    
    function selectProduct(product) {
        items.push({
            product_id: product.id,
            sku: product.sku,
            product_name: product.name,
            quantity: 1,
            unit_price: product.standard_price || 0
        });
        productModal.hide();
        renderItems();
    }
    
    function removeItem(index) {
        items.splice(index, 1);
        renderItems();
    }
    
    function updateItemQuantity(index, qty) {
        items[index].quantity = parseInt(qty) || 1;
        calculateTotal();
    }
    
    function updateItemPrice(index, price) {
        items[index].unit_price = parseFloat(price) || 0;
        calculateTotal();
    }
    
    function renderItems() {
        const tbody = document.getElementById('itemsTable');
        
        if (items.length === 0) {
            tbody.innerHTML = `
                <tr id="emptyRow">
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-bag-plus fs-1 d-block mb-2"></i>
                        คลิก "เพิ่มรายการ" เพื่อเพิ่มสินค้า
                    </td>
                </tr>
            `;
            calculateTotal();
            return;
        }
        
        tbody.innerHTML = items.map((item, i) => `
            <tr>
                <td>
                    <div class="fw-semibold">${item.sku}</div>
                    <small class="text-muted">${item.product_name}</small>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${item.quantity}" min="1" 
                           onchange="updateItemQuantity(${i}, this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm text-mono" 
                           value="${item.unit_price}" step="0.01"
                           onchange="updateItemPrice(${i}, this.value)">
                </td>
                <td class="text-mono">฿${(item.quantity * item.unit_price).toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${i})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        calculateTotal();
    }
    
    function calculateTotal() {
        const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
        const shipping = parseFloat(document.querySelector('[name="shipping_fee"]').value) || 0;
        const discount = parseFloat(document.querySelector('[name="discount_amount"]').value) || 0;
        const total = subtotal + shipping - discount;
        
        document.getElementById('subtotal').textContent = `฿${subtotal.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `฿${total.toFixed(2)}`;
    }
    
    // Product search
    let searchTimeout;
    document.getElementById('productSearch').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchProducts(e.target.value), 300);
    });
    
    async function searchProducts(term) {
        if (!term) return;
        
        try {
            const res = await fetch(`/api/products?search=${encodeURIComponent(term)}`);
            if (res.ok) {
                const data = await res.json();
                renderProductList(data.products);
            }
        } catch (e) {
            console.error('Product search failed:', e);
        }
    }
    
    function renderProductList(products) {
        const tbody = document.getElementById('productList');
        
        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ไม่พบสินค้า</td></tr>';
            return;
        }
        
        tbody.innerHTML = products.map(p => `
            <tr class="cursor-pointer" onclick='selectProduct(${JSON.stringify(p)})'>
                <td>
                    <img src="${p.image_url || '/static/img/no-image.png'}" class="product-thumb" alt="">
                </td>
                <td class="text-mono">${p.sku}</td>
                <td>${p.name}</td>
                <td class="text-mono">฿${p.standard_price || 0}</td>
                <td><button class="btn btn-sm btn-primary"><i class="bi bi-plus"></i></button></td>
            </tr>
        `).join('');
    }
    
    async function submitOrder(e) {
        e.preventDefault();
        
        if (items.length === 0) {
            alert('กรุณาเพิ่มสินค้าอย่างน้อย 1 รายการ');
            return;
        }
        
        const form = document.getElementById('orderForm');
        const formData = new FormData(form);
        
        const orderData = {
            channel_code: formData.get('channel_code'),
            customer_name: formData.get('customer_name'),
            customer_phone: formData.get('customer_phone'),
            customer_address: formData.get('customer_address'),
            payment_method: formData.get('payment_method'),
            shipping_method: formData.get('shipping_method'),
            shipping_fee: parseFloat(formData.get('shipping_fee')) || 0,
            discount_amount: parseFloat(formData.get('discount_amount')) || 0,
            items: items
        };
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> กำลังสร้าง...';
        
        try {
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            
            if (res.ok) {
                const data = await res.json();
                window.location.href = `/orders/${data.id}`;
            } else {
                const error = await res.json();
                alert(error.detail || 'เกิดข้อผิดพลาดในการสร้างออเดอร์');
            }
        } catch (e) {
            console.error('Failed to create order:', e);
            alert('เกิดข้อผิดพลาดในการสร้างออเดอร์');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> สร้างออเดอร์';
        }
    }
</script>
{% endblock %}
