{% extends "base.html" %}

{% block title %}Platform Integrations - WeOrder{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Platform Integrations</h1>
        <p class="text-muted mb-0">Manage connections to Shopee, Lazada, TikTok Shop</p>
    </div>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="syncAllPlatforms()">
            <i class="bi bi-arrow-repeat me-1"></i> Sync All
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlatformModal">
            <i class="bi bi-plus-lg me-1"></i> Add Platform
        </button>
    </div>
</div>

<!-- Platform Cards -->
<div class="row g-4" id="platformCards">
    {% for config in platforms %}
    <div class="col-md-6 col-lg-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="platform-icon me-3 {{ config.platform }}">
                        {% if config.platform == 'shopee' %}
                        <i class="bi bi-shop" style="font-size: 1.5rem; color: #EE4D2D;"></i>
                        {% elif config.platform == 'lazada' %}
                        <i class="bi bi-bag" style="font-size: 1.5rem; color: #0F146D;"></i>
                        {% elif config.platform == 'tiktok' %}
                        <i class="bi bi-tiktok" style="font-size: 1.5rem; color: #000;"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">{{ config.shop_name or config.shop_id }}</h5>
                        <small class="text-muted text-uppercase">{{ config.platform }}</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" 
                               id="active_{{ config.id }}" 
                               {% if config.is_active %}checked{% endif %}
                               onchange="toggleActive('{{ config.id }}', this.checked)">
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between text-muted small mb-1">
                        <span>Shop ID</span>
                        <span class="font-monospace">{{ config.shop_id }}</span>
                    </div>
                    <div class="d-flex justify-content-between text-muted small mb-1">
                        <span>Sync Interval</span>
                        <span>{{ config.sync_interval_minutes }} mins</span>
                    </div>
                    <div class="d-flex justify-content-between text-muted small mb-1">
                        <span>Last Sync</span>
                        <span>{{ config.last_sync_at.strftime('%d/%m %H:%M') if config.last_sync_at else 'Never' }}</span>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span>Token Expires</span>
                        <span class="{% if config.token_expires_at and config.token_expires_at < now %}text-danger{% endif %}">
                            {{ config.token_expires_at.strftime('%d/%m/%Y') if config.token_expires_at else 'Not set' }}
                        </span>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary flex-grow-1" 
                            onclick="triggerSync('{{ config.id }}')">
                        <i class="bi bi-arrow-repeat"></i> Sync Now
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            onclick="editPlatform('{{ config.id }}')">
                        <i class="bi bi-gear"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deletePlatform('{{ config.id }}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            
            <!-- Sync Status Footer -->
            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge {% if config.sync_enabled %}bg-success{% else %}bg-secondary{% endif %}">
                        {% if config.sync_enabled %}Auto-sync ON{% else %}Auto-sync OFF{% endif %}
                    </span>
                    <a href="#" class="small text-muted" onclick="showSyncHistory('{{ config.id }}')">
                        View History
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-plug text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No Platforms Connected</h5>
                <p class="text-muted">Add your first marketplace integration to start syncing orders</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlatformModal">
                    <i class="bi bi-plus-lg me-1"></i> Add Platform
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Webhook Status -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-broadcast me-2"></i>Webhook Endpoints</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Configure these URLs in your marketplace developer settings to receive real-time order updates:</p>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Platform</th>
                        <th>Webhook URL</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><i class="bi bi-shop text-danger me-2"></i>Shopee</td>
                        <td><code>{{ webhook_base_url }}/api/webhooks/shopee</code></td>
                        <td><span class="badge bg-success">Active</span></td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-bag text-primary me-2"></i>Lazada</td>
                        <td><code>{{ webhook_base_url }}/api/webhooks/lazada</code></td>
                        <td><span class="badge bg-success">Active</span></td>
                    </tr>
                    <tr>
                        <td><i class="bi bi-tiktok me-2"></i>TikTok Shop</td>
                        <td><code>{{ webhook_base_url }}/api/webhooks/tiktok</code></td>
                        <td><span class="badge bg-success">Active</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Platform Modal -->
<div class="modal fade" id="addPlatformModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Platform Connection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPlatformForm" onsubmit="submitPlatform(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Platform</label>
                        <select class="form-select" name="platform" required>
                            <option value="">Select platform...</option>
                            <option value="shopee">Shopee</option>
                            <option value="lazada">Lazada</option>
                            <option value="tiktok">TikTok Shop</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Shop ID</label>
                        <input type="text" class="form-control" name="shop_id" required 
                               placeholder="Your shop ID from platform">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Shop Name</label>
                        <input type="text" class="form-control" name="shop_name" required
                               placeholder="Display name for this shop">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">App Key / Partner ID</label>
                        <input type="text" class="form-control" name="app_key" required
                               placeholder="From developer portal">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">App Secret / Partner Key</label>
                        <input type="password" class="form-control" name="app_secret" required
                               placeholder="Keep this secure">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sync Interval (minutes)</label>
                        <select class="form-select" name="sync_interval_minutes">
                            <option value="5">Every 5 minutes</option>
                            <option value="10">Every 10 minutes</option>
                            <option value="15" selected>Every 15 minutes</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="60">Every hour</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Platform</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sync History Modal -->
<div class="modal fade" id="syncHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sync History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="syncHistoryTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Fetched</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Add new platform
async function submitPlatform(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.sync_interval_minutes = parseInt(data.sync_interval_minutes);
    
    try {
        const response = await fetch('/api/integrations/platforms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to add platform'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Toggle platform active status
async function toggleActive(configId, isActive) {
    try {
        await fetch(`/api/integrations/platforms/${configId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({is_active: isActive})
        });
    } catch (e) {
        alert('Error: ' + e.message);
        location.reload();
    }
}

// Trigger sync
async function triggerSync(configId) {
    try {
        const response = await fetch(`/api/integrations/platforms/${configId}/sync`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hours_back: 24})
        });
        
        if (response.ok) {
            alert('Sync started! Check back in a moment.');
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to start sync'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Sync all platforms
async function syncAllPlatforms() {
    try {
        const response = await fetch('/api/integrations/sync-all', {method: 'POST'});
        if (response.ok) {
            const result = await response.json();
            alert(`Sync started for ${result.platforms_count} platforms`);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Show sync history
async function showSyncHistory(configId) {
    try {
        const response = await fetch(`/api/integrations/platforms/${configId}/sync-history`);
        const jobs = await response.json();
        
        const tbody = document.querySelector('#syncHistoryTable tbody');
        tbody.innerHTML = jobs.map(job => `
            <tr>
                <td>${new Date(job.started_at).toLocaleString('th-TH')}</td>
                <td><span class="badge ${job.job_type === 'WEBHOOK' ? 'bg-info' : 'bg-secondary'}">${job.job_type}</span></td>
                <td><span class="badge ${job.status === 'SUCCESS' ? 'bg-success' : (job.status === 'FAILED' ? 'bg-danger' : 'bg-warning')}">${job.status}</span></td>
                <td>${job.orders_fetched}</td>
                <td>${job.orders_created}</td>
                <td>${job.orders_updated}</td>
                <td class="text-danger small">${job.error_message || '-'}</td>
            </tr>
        `).join('');
        
        new bootstrap.Modal(document.getElementById('syncHistoryModal')).show();
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Delete platform
async function deletePlatform(configId) {
    if (!confirm('Are you sure you want to delete this platform connection?')) return;
    
    try {
        const response = await fetch(`/api/integrations/platforms/${configId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete platform');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Edit platform (placeholder)
function editPlatform(configId) {
    alert('Edit functionality coming soon!');
}
</script>
{% endblock %}
